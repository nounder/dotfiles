#!/usr/bin/env bash
# Search and select Nerd Font icons using fzf

# Get program name
PROGRAM="$(basename "$0")"

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# Get the dotfiles root directory (parent of bin)
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
NERDFONTS_TSV="$DOTFILES_DIR/NerdFonts.tsv"

# Download or load TSV file
load_tsv_file() {
    local source="$1"

    # Check if source is a URL
    if [[ "$source" =~ ^https?:// ]]; then
        # Download to temporary file
        local temp_file=$(mktemp)
        if ! curl -fsSL "$source" -o "$temp_file"; then
            echo "Error: Failed to download TSV from $source" >&2
            rm -f "$temp_file"
            exit 1
        fi
        NERDFONTS_TSV="$temp_file"
    else
        # Use local file
        if [[ ! -f "$source" ]]; then
            echo "Error: TSV file not found at $source" >&2
            exit 1
        fi
        NERDFONTS_TSV="$source"
    fi
}

# Check if NerdFonts.tsv exists
check_tsv_file() {
    if [[ ! -f "$NERDFONTS_TSV" ]]; then
        echo "Error: NerdFonts.tsv not found at $NERDFONTS_TSV" >&2
        exit 1
    fi
}

# Print all icons or filtered icons
print_icons() {
    local filter="$1"

    # Check if stdout is a terminal (interactive mode)
    if [[ -t 1 ]] && command -v less &> /dev/null; then
        # Interactive mode - pipe through less
        if [[ -n "$filter" ]]; then
            awk -F'\t' -v pattern="$filter" '$2 ~ pattern {printf "%-5s %-50s %s\n", $1, $2, $3}' "$NERDFONTS_TSV" | less -R
        else
            awk -F'\t' '{printf "%-5s %-50s %s\n", $1, $2, $3}' "$NERDFONTS_TSV" | less -R
        fi
    else
        # Non-interactive mode - print directly
        if [[ -n "$filter" ]]; then
            awk -F'\t' -v pattern="$filter" '$2 ~ pattern {printf "%-5s %-50s %s\n", $1, $2, $3}' "$NERDFONTS_TSV"
        else
            awk -F'\t' '{printf "%-5s %-50s %s\n", $1, $2, $3}' "$NERDFONTS_TSV"
        fi
    fi
}

# Copy text to clipboard
copy_to_clipboard() {
    local text="$1"

    if command -v xclip &> /dev/null; then
        echo -n "$text" | xclip -selection clipboard
        return 0
    elif command -v pbcopy &> /dev/null; then
        echo -n "$text" | pbcopy
        return 0
    elif command -v wl-copy &> /dev/null; then
        echo -n "$text" | wl-copy
        return 0
    fi
    return 1
}

# Interactive fzf search
search_with_fzf() {
    local filter="$1"
    local source_data

    if [[ -n "$filter" ]]; then
        # Apply filter to class column before piping to fzf
        source_data=$(awk -F'\t' -v pattern="$filter" '$2 ~ pattern' "$NERDFONTS_TSV")
    else
        source_data=$(cat "$NERDFONTS_TSV")
    fi

    local selected
    selected=$(echo "$source_data" | \
        fzf --ansi \
            --header="Search Nerd Fonts - Press ENTER to copy, ESC to quit" \
            --preview='echo -e "Icon: {1}\nClass: {2}\nCodepoint: {3}"' \
            --preview-window=up:3:wrap \
            --delimiter=$'\t' \
            --with-nth=1,2 \
            --bind='ctrl-y:execute-silent(echo -n {1} | xclip -selection clipboard)+abort' \
            --bind='ctrl-c:execute-silent(echo -n {2} | xclip -selection clipboard)+abort' \
            --bind='ctrl-u:execute-silent(echo -n {3} | xclip -selection clipboard)+abort')

    # If something was selected, output it
    if [[ -n "$selected" ]]; then
        local icon class codepoint
        icon=$(echo "$selected" | cut -f1)
        class=$(echo "$selected" | cut -f2)
        codepoint=$(echo "$selected" | cut -f3)

        echo "Selected:"
        echo "  Icon: $icon"
        echo "  Class: $class"
        echo "  Codepoint: $codepoint"
        echo ""

        if copy_to_clipboard "$icon"; then
            echo "The icon has been copied to your clipboard"
        else
            echo "Clipboard copy not available (install xclip, pbcopy, or wl-copy)"
        fi
    fi
}

# Main function
main() {
    local filter=""
    local custom_source=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --source)
                custom_source="$2"
                shift 2
                ;;
            -*)
                echo "Error: Unknown option $1" >&2
                echo "Usage: $PROGRAM [FILTER] [--source FILE_OR_URL]" >&2
                exit 1
                ;;
            *)
                filter="$1"
                shift
                ;;
        esac
    done

    # Load custom TSV file if specified
    if [[ -n "$custom_source" ]]; then
        load_tsv_file "$custom_source"
    fi

    check_tsv_file

    if command -v fzf &> /dev/null; then
        # Use interactive fzf search
        search_with_fzf "$filter"
    else
        # Print all icons (or filtered) to stdout
        print_icons "$filter"
    fi
}

main "$@"
